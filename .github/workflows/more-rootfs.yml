name: More ARM64 RootFS
on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/more-rootfs.yml'
      - 'Dockerfile.*'
  workflow_dispatch:
# è§£å†³ Release 403 æƒé™é—®é¢˜
permissions:
  contents: write
  actions: read

jobs:
  # 1. Ubuntu æ„å»ºï¼ˆå¹¶å‘ä»»åŠ¡1ï¼‰
  build-ubuntu:
    runs-on: ubuntu-latest
    outputs:
      file: ubuntu-22.04-arm64-rootfs.tar.xz
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: docker/setup-buildx-action@v3
      - run: |
          mkdir -p ./rootfs-output
          docker build --platform linux/arm64 -t ubuntu-rootfs -f Dockerfile.ubuntu .
          CID=$(docker run -d --platform linux/arm64 ubuntu-rootfs sleep 30)
          docker export $CID | xz -9e > ./rootfs-output/ubuntu-22.04-arm64-rootfs.tar.xz
          docker stop $CID && docker rm $CID
      - uses: actions/upload-artifact@v4
        with:
          name: ubuntu-rootfs
          path: ./rootfs-output/ubuntu-22.04-arm64-rootfs.tar.xz
          retention-days: 1

  # 2. Debian æ„å»ºï¼ˆå¹¶å‘ä»»åŠ¡2ï¼Œä¸ Ubuntu åŒæ—¶æ‰§è¡Œï¼‰
  build-debian:
    runs-on: ubuntu-latest
    outputs:
      file: debian-12-arm64-rootfs.tar.xz
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: docker/setup-buildx-action@v3
      - run: |
          mkdir -p ./rootfs-output
          docker build --platform linux/arm64 -t debian-rootfs -f Dockerfile.debian .
          CID=$(docker run -d --platform linux/arm64 debian-rootfs sleep 30)
          docker export $CID | xz -9e > ./rootfs-output/debian-12-arm64-rootfs.tar.xz
          docker stop $CID && docker rm $CID
      - uses: actions/upload-artifact@v4
        with:
          name: debian-rootfs
          path: ./rootfs-output/debian-12-arm64-rootfs.tar.xz
          retention-days: 1

  # 3. Alpine æ„å»ºï¼ˆå¹¶å‘ä»»åŠ¡3ï¼Œä¸å‰ä¸¤ä¸ªåŒæ—¶æ‰§è¡Œï¼‰
  build-alpine:
    runs-on: ubuntu-latest
    outputs:
      file: alpine-3.19-arm64-rootfs.tar.xz
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: docker/setup-buildx-action@v3
      - run: |
          mkdir -p ./rootfs-output
          docker build --platform linux/arm64 -t alpine-rootfs -f Dockerfile.alpine .
          CID=$(docker run -d --platform linux/arm64 alpine-rootfs sleep 30)
          docker export $CID | xz -9e > ./rootfs-output/alpine-3.19-arm64-rootfs.tar.xz
          docker stop $CID && docker rm $CID
      - uses: actions/upload-artifact@v4
        with:
          name: alpine-rootfs
          path: ./rootfs-output/alpine-3.19-arm64-rootfs.tar.xz
          retention-days: 1

  # 4. ArchARM æ„å»ºï¼ˆå¹¶å‘ä»»åŠ¡4ï¼Œä¸æ‰€æœ‰ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼‰
  build-archarm:
    runs-on: ubuntu-latest
    outputs:
      file: archlinuxarm-aarch64-rootfs.tar.xz
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: docker/setup-buildx-action@v3
      - run: |
          mkdir -p ./rootfs-output
          docker build --platform linux/arm64 -t archarm-rootfs -f Dockerfile.archarm .
          CID=$(docker run -d --platform linux/arm64 archarm-rootfs sleep 30)
          docker export $CID | xz -9e > ./rootfs-output/archlinuxarm-aarch64-rootfs.tar.xz
          docker stop $CID && docker rm $CID
      - uses: actions/upload-artifact@v4
        with:
          name: archarm-rootfs
          path: ./rootfs-output/archlinuxarm-aarch64-rootfs.tar.xz
          retention-days: 1

  # 5. ç»Ÿä¸€åˆ›å»º Releaseï¼ˆç­‰å¾…æ‰€æœ‰æ„å»ºä»»åŠ¡å®Œæˆåæ‰§è¡Œï¼‰
  create-release:
    runs-on: ubuntu-latest
    # ä¾èµ–æ‰€æœ‰æ„å»ºä»»åŠ¡ï¼Œç¡®ä¿å…¨éƒ¨å®Œæˆå†æ‰“åŒ…Release
    needs: [build-ubuntu, build-debian, build-alpine, build-archarm]
    steps:
      - run: mkdir -p ./rootfs-output
      # ä¸‹è½½æ‰€æœ‰å‘è¡Œç‰ˆçš„æ„å»ºäº§ç‰©
      - uses: actions/download-artifact@v4
        with:
          path: ./rootfs-output
          pattern: *-rootfs
          merge-multiple: true
      # åˆ›å»ºåŒ…å«æ‰€æœ‰äº§ç‰©çš„Release
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.sha_short }}-${{ date('YYYYMMDD') }}
          name: Multi-Distro ARM64 RootFS ${{ date('YYYYMMDD') }}
          body: |
            ğŸ“¦ æœ¬æ¬¡æ„å»ºåŒ…å«ä»¥ä¸‹å‘è¡Œç‰ˆï¼ˆARM64æ¶æ„ï¼‰ï¼š
            - Ubuntu 22.04: ${{ needs.build-ubuntu.outputs.file }}
            - Debian 12: ${{ needs.build-debian.outputs.file }}
            - Alpine 3.19: ${{ needs.build-alpine.outputs.file }}
            - ArchARM: ${{ needs.build-archarm.outputs.file }}
          files: ./rootfs-output/*.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
