name: æ„å»ºå…¨é‡Linuxå‘è¡Œç‰ˆarm64 RootFS

on:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/build-all-arm64-rootfs.yml' ]  # ä»…è¯¥æ–‡ä»¶å˜æ›´æ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      debug_mode:
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆä¿ç•™ä¸´æ—¶æ–‡ä»¶ï¼Œä¾¿äºæ’é”™ï¼‰"
        type: boolean
        default: false

jobs:
  build-arm64-rootfs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # å•ä¸ªå‘è¡Œç‰ˆå¤±è´¥ä¸é˜»æ–­å…¶ä»–æ„å»º
      matrix:
        include:
          # Debianç³»ï¼ˆç»Ÿä¸€ç”¨debootstrapï¼‰
          - name: debian
            type: debian-like
            release: bookworm
            mirror: "http://mirrors.ustc.edu.cn/debian-ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/debian-ports/archive-key.gpg"
          - name: ubuntu
            type: debian-like
            release: jammy
            mirror: "http://mirrors.ustc.edu.cn/ubuntu-ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/ubuntu-ports/archive-key-2025.gpg"  # è¡¥å……Ubuntu GPGå¯†é’¥
          - name: deepin
            type: debian-like
            release: apricot
            mirror: "http://mirrors.ustc.edu.cn/deepin-ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/deepin-ports/archive-key.gpg"
          - name: openkylin
            type: debian-like
            release: 1.0
            mirror: "http://mirrors.ustc.edu.cn/openkylin/ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/openkylin/ports/archive-key.gpg"
          - name: kali
            type: debian-like
            release: kali-rolling
            mirror: "http://mirrors.ustc.edu.cn/kali-ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/kali-ports/archive-key.asc"
          - name: parrot
            type: debian-like
            release: rolling
            mirror: "http://mirrors.ustc.edu.cn/parrot-ports/"
            gpg_key: "https://mirrors.ustc.edu.cn/parrot-ports/archive-key.asc"
          - name: backbox
            type: debian-like
            release: 7
            mirror: "http://mirrors.ustc.edu.cn/backbox-ports/7/"
            gpg_key: "https://mirrors.ustc.edu.cn/backbox-ports/archive-key.asc"
          # Archç³»ï¼ˆç»Ÿä¸€ç”¨pacstrap/basestrapï¼‰
          - name: arch
            type: arch-like
            release: aarch64
            mirror: "https://mirrors.tuna.tsinghua.edu.cn/archlinuxarm/$repo/$arch"
            gpg_key: ""  # ArchARMå¯†é’¥é€šè¿‡pacman-key --populateè‡ªåŠ¨å¯¼å…¥
          - name: manjaro
            type: arch-like
            release: aarch64-unstable
            mirror: "https://mirrors.tuna.tsinghua.edu.cn/manjaro-arm/$repo/$arch"
            gpg_key: ""
          - name: artix
            type: arch-like
            release: aarch64
            mirror: "https://mirrors.tuna.tsinghua.edu.cn/artix-linux/$repo/$arch"
            gpg_key: ""
          # RHEL/Fedoraç³»ï¼ˆç»Ÿä¸€ç”¨dnfï¼‰
          - name: fedora
            type: rhel-like
            release: 40
            mirror: "http://mirrors.ustc.edu.cn/fedora-secondary/releases/$release/Everything/aarch64/os/"
            gpg_key: "https://getfedora.org/static/fedora.gpg"
          - name: centos_stream
            type: rhel-like
            release: 9
            mirror: "http://mirrors.ustc.edu.cn/centos-stream/$release-stream/BaseOS/aarch64/os/"
            gpg_key: "https://mirrors.ustc.edu.cn/centos-stream/RPM-GPG-KEY-CentOS-Stream-9"
          - name: rocky
            type: rhel-like
            release: 9
            mirror: "http://mirrors.ustc.edu.cn/rocky/$release/BaseOS/aarch64/os/"
            gpg_key: "https://mirrors.ustc.edu.cn/rocky/RPM-GPG-KEY-rockyofficial"
          # SUSEç³»ï¼ˆzypperï¼‰
          - name: opensuse
            type: suse-like
            release: tumbleweed
            mirror: "http://mirrors.ustc.edu.cn/opensuse/ports/tumbleweed/repo/oss/aarch64/"
            gpg_key: "https://mirrors.ustc.edu.cn/opensuse/ports/tumbleweed/repo/oss/aarch64/repodata/repomd.xml.key"
          # Alpineç³»ï¼ˆalpine-make-rootfs/apkï¼‰
          - name: alpine
            type: alpine-like
            release: 3.20
            mirror: "http://mirrors.tuna.tsinghua.edu.cn/alpine/v$release/main/"  # ä¿®å¤Alpineé•œåƒè·¯å¾„ï¼ˆéœ€æŒ‡å®šmainä»“åº“ï¼‰
            gpg_key: ""
          - name: adelie
            type: alpine-like
            release: 1.0
            mirror: "http://mirrors.ustc.edu.cn/adelie/os/aarch64/main/"
            gpg_key: "https://adelielinux.org/keys/adelie-devel.asc"
          # ç‹¬ç«‹ç³»
          - name: void
            type: void-like
            release: current
            mirror: "https://mirrors.tuna.tsinghua.edu.cn/voidlinux/current/aarch64/"
            gpg_key: "https://mirrors.tuna.tsinghua.edu.cn/voidlinux/void-release-20240120.pub"
          - name: pardus
            type: pardus-like
            release: 23
            mirror: "http://mirrors.ustc.edu.cn/pardus-archive/23/aarch64/main/"
            gpg_key: "https://pardus.org.tr/keys/pardus-23.gpg"
          - name: chimera
            type: chimera-like
            release: 1.0
            mirror: "http://mirrors.ustc.edu.cn/chimeraos/repo/aarch64/"
            gpg_key: "https://chimeraos.org/gpg.pub"
          - name: gentoo
            type: gentoo-like
            release: stage3
            mirror: "http://mirrors.ustc.edu.cn/gentoo/releases/aarch64/autobuilds/current-stage3-arm64-desktop-systemd/"
            gpg_key: ""

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå›ºå®šv4ç‰ˆæœ¬ï¼Œç¡®ä¿ç¨³å®šæ€§ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼Œå‡å°‘è€—æ—¶

      # 2. å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆä¿®å¤Ubuntuæ— xbps-installçš„é—®é¢˜ï¼Œè¡¥å……å…³é”®å·¥å…·ï¼‰
      - name: Install core dependencies
        run: |
          set -euo pipefail
          # ä¼˜å…ˆä½¿ç”¨ustcé•œåƒåŠ é€ŸAPT
          sudo sed -i 's@http://archive.ubuntu.com/ubuntu/@http://mirrors.ustc.edu.cn/ubuntu/@g' /etc/apt/sources.list
          sudo apt update -y || { echo "âŒ APTæ›´æ–°å¤±è´¥ï¼ˆæ£€æŸ¥ç½‘ç»œæˆ–é•œåƒï¼‰"; exit 1; }
          
          # å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆç§»é™¤xbps-installï¼ŒUbuntuæºæ— æ­¤åŒ…ï¼Œåç»­æ‰‹åŠ¨ä¸‹è½½ï¼‰
          sudo apt install -y \
            debootstrap arch-install-scripts basestrap \
            xz-utils tar gzip wget curl \
            qemu-user-static binfmt-support \
            dnf zypper || { echo "âŒ æ ¸å¿ƒä¾èµ–å®‰è£…å¤±è´¥"; exit 1; }
          
          # æ‰‹åŠ¨ä¸‹è½½Voidçš„xbps-installï¼ˆè§£å†³Ubuntuæ— xbps-installçš„é—®é¢˜ï¼‰
          sudo wget -O /usr/bin/xbps-install \
            https://mirrors.tuna.tsinghua.edu.cn/voidlinux/current/aarch64/static/xbps-install.static \
            || { echo "âŒ xbps-installä¸‹è½½å¤±è´¥"; exit 1; }
          sudo chmod +x /usr/bin/xbps-install
          
          # æ³¨å†ŒQEMU-aarch64æ¨¡æ‹Ÿï¼ˆå¿…é¡»æ­¥éª¤ï¼Œå¦åˆ™æ— æ³•chrootåˆ°arm64ç¯å¢ƒï¼‰
          sudo update-binfmts --enable qemu-aarch64 || { echo "âŒ QEMU-aarch64æ³¨å†Œå¤±è´¥"; exit 1; }
          echo "âœ… æ ¸å¿ƒä¾èµ–å®‰è£…å®Œæˆ"

      # 3. åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼ˆç»Ÿä¸€æ—¥æœŸæ ¼å¼ï¼Œåˆ›å»ºå®‰å…¨è·¯å¾„ï¼‰
      - name: Init build env
        run: |
          set -euo pipefail
          # ç”¨GitHubå†…ç½®æ—¶é—´ç”Ÿæˆ8ä½æ—¥æœŸï¼ˆYYYYMMddï¼‰ï¼Œç¡®ä¿äº§ç‰©åå”¯ä¸€
          DATE_STR="${{ format('{0:YYYYMMdd}', github.run_started_at) }}"
          # äº§ç‰©åæ ¼å¼ï¼šå‘è¡Œç‰ˆ-ç‰ˆæœ¬-æ¶æ„-æ—¥æœŸ.rootfs.xzï¼ˆæ¸…æ™°æ˜“åŒºåˆ†ï¼‰
          ROOTFS_NAME="${{ matrix.name }}-${{ matrix.release }}-arm64-${DATE_STR}.rootfs.xz"
          # æŒ‚è½½ç›®å½•ç”¨/tmpï¼ˆé¿å…/mntæƒé™é—®é¢˜ï¼‰ï¼Œæ·»åŠ éšæœºåç¼€é˜²æ­¢å†²çª
          ROOTFS_MOUNT="/tmp/arm64-rootfs-${{ matrix.name }}-$RANDOM"
          
          # å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ROOTFS_NAME=$ROOTFS_NAME" >> "$GITHUB_ENV"
          echo "ROOTFS_MOUNT=$ROOTFS_MOUNT" >> "$GITHUB_ENV"
          
          # åˆ›å»ºæŒ‚è½½ç›®å½•å¹¶è®¾ç½®æƒé™
          sudo mkdir -p "$ROOTFS_MOUNT" || { echo "âŒ æŒ‚è½½ç›®å½•åˆ›å»ºå¤±è´¥"; exit 1; }
          sudo chmod 755 "$ROOTFS_MOUNT" || { echo "âŒ æŒ‚è½½ç›®å½•æƒé™è®¾ç½®å¤±è´¥"; exit 1; }
          
          echo "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          echo "  - äº§ç‰©åï¼š$ROOTFS_NAME"
          echo "  - æŒ‚è½½ç›®å½•ï¼š$ROOTFS_MOUNT"

      # 4. ç”Ÿæˆæ„å»ºè„šæœ¬ï¼ˆä¿®å¤å¤šå‘è¡Œç‰ˆé€»è¾‘æ¼æ´ï¼Œè¡¥å……å…³é”®åˆå§‹åŒ–æ­¥éª¤ï¼‰
      - name: Generate build script
        run: |
          set -euo pipefail
          cat > build.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼ï¼šé”™è¯¯/æœªå®šä¹‰å˜é‡/ç®¡é“å¤±è´¥å‡é€€å‡º
          ROOTFS_NAME="$1"
          ROOTFS_MOUNT="$2"
          # ä»çŸ©é˜µå˜é‡æ³¨å…¥æ„å»ºå‚æ•°
          DISTRO_NAME="${{ matrix.name }}"
          DISTRO_TYPE="${{ matrix.type }}"
          DISTRO_RELEASE="${{ matrix.release }}"
          DISTRO_MIRROR="${{ matrix.mirror }}"
          DISTRO_GPG="${{ matrix.gpg_key }}"
          DEBUG_MODE="${{ github.event.inputs.debug_mode }}"

          # -------------------------- é€šç”¨å·¥å…·å‡½æ•° --------------------------
          # é”™è¯¯å¤„ç†ï¼šè¾“å‡ºæç¤ºå¹¶æ¸…ç†ç¯å¢ƒ
          error_exit() {
            echo -e "\033[31mâŒ $1\033[0m"
            if [ "$DEBUG_MODE" = "false" ]; then
              # å¼ºåˆ¶å¸è½½æŒ‚è½½ç‚¹ï¼ˆé¿å…å ç”¨ï¼‰
              sudo umount -l "$ROOTFS_MOUNT" 2>/dev/null || true
              sudo rm -rf "$ROOTFS_MOUNT"
            fi
            exit 1
          }

          # GPGå¯†é’¥å¯¼å…¥ï¼ˆä»…å½“å¯†é’¥å­˜åœ¨æ—¶æ‰§è¡Œï¼‰
          import_gpg() {
            if [ -n "$1" ] && [ "$1" != "null" ]; then
              echo "ğŸ”‘ å¯¼å…¥GPGå¯†é’¥ï¼š$1"
              sudo curl -fsSL "$1" -o /tmp/distro.gpg || error_exit "GPGå¯†é’¥ä¸‹è½½å¤±è´¥"
              # åˆ†å‘è¡Œç‰ˆå¤„ç†GPGå¯†é’¥ï¼ˆDebianç³»ç”¨aptä¿¡ä»»ï¼ŒRPMç³»ç”¨rpmå¯¼å…¥ï¼‰
              if [[ "$DISTRO_TYPE" =~ "debian-like" || "$DISTRO_TYPE" =~ "alpine-like" ]]; then
                sudo gpg --dearmor -o "/etc/apt/trusted.gpg.d/${DISTRO_NAME}.gpg" /tmp/distro.gpg \
                  || error_exit "GPGå¯†é’¥è½¬æ¢å¤±è´¥ï¼ˆDebian/Alpineç³»ï¼‰"
              else
                sudo rpm --import /tmp/distro.gpg || error_exit "GPGå¯†é’¥å¯¼å…¥å¤±è´¥ï¼ˆRPMç³»ï¼‰"
              fi
            fi
          }

          # -------------------------- Debianç³»æ„å»ºï¼ˆä¿®å¤å¯†é’¥ä¿¡ä»»é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "debian-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Debianç³»ï¼š$DISTRO_NAME $DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # æ‰§è¡Œdebootstrapç¬¬ä¸€é˜¶æ®µï¼ˆä»…ä¸‹è½½åŒ…ï¼Œä¸æ‰§è¡Œé…ç½®ï¼‰
            sudo debootstrap --arch=arm64 --foreign "$DISTRO_RELEASE" "$ROOTFS_MOUNT" "$DISTRO_MIRROR" \
              || error_exit "debootstrapç¬¬ä¸€é˜¶æ®µå¤±è´¥ï¼ˆæ£€æŸ¥é•œåƒæ˜¯å¦æ”¯æŒarm64ï¼‰"
            
            # å¤åˆ¶QEMUè§£é‡Šå™¨ï¼ˆchrootå¿…éœ€ï¼‰
            sudo cp /usr/bin/qemu-aarch64-static "$ROOTFS_MOUNT/usr/bin/" \
              || error_exit "QEMU-aarch64å¤åˆ¶å¤±è´¥"
            
            # æ‰§è¡Œdebootstrapç¬¬äºŒé˜¶æ®µï¼ˆé…ç½®ç³»ç»Ÿï¼‰
            sudo chroot "$ROOTFS_MOUNT" /debootstrap/debootstrap --second-stage \
              || error_exit "debootstrapç¬¬äºŒé˜¶æ®µå¤±è´¥ï¼ˆQEMUæ¨¡æ‹Ÿå¼‚å¸¸ï¼‰"
            
            # æ¸…ç†APTç¼“å­˜ï¼ˆå‡å°‘äº§ç‰©ä½“ç§¯ï¼‰
            sudo chroot "$ROOTFS_MOUNT" apt clean || error_exit "APTç¼“å­˜æ¸…ç†å¤±è´¥"
            sudo rm -rf "$ROOTFS_MOUNT/var/lib/apt/lists/*" || true
          fi

          # -------------------------- Archç³»æ„å»ºï¼ˆä¿®å¤å¯†é’¥åˆå§‹åŒ–é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "arch-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Archç³»ï¼š$DISTRO_NAME $DISTRO_RELEASE (arm64)"
            # é…ç½®é•œåƒæºï¼ˆArchç³»éœ€æŒ‡å®š$repo/$archå˜é‡ï¼‰
            echo "Server = $DISTRO_MIRROR" | sudo tee /etc/pacman.d/mirrorlist \
              || error_exit "é•œåƒæºé…ç½®å¤±è´¥"
            
            # åˆå§‹åŒ–Pacmanå¯†é’¥ç¯
            sudo pacman-key --init || error_exit "Pacmanå¯†é’¥ç¯åˆå§‹åŒ–å¤±è´¥"
            if [ "$DISTRO_NAME" = "artix" ]; then
              sudo pacman-key --populate artix || error_exit "Artixå¯†é’¥å¯¼å…¥å¤±è´¥"
            else
              sudo pacman-key --populate archlinuxarm || error_exit "ArchARMå¯†é’¥å¯¼å…¥å¤±è´¥"
            fi
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿï¼ˆArtixç”¨basestrapï¼Œå…¶ä»–ç”¨pacstrapï¼‰
            if [ "$DISTRO_NAME" = "artix" ]; then
              sudo basestrap -C /etc/pacman.conf -K --arch=aarch64 "$ROOTFS_MOUNT" base \
                || error_exit "basestrapæ„å»ºå¤±è´¥"
            else
              sudo pacstrap -C /etc/pacman.conf -K --arch=aarch64 "$ROOTFS_MOUNT" base \
                || error_exit "pacstrapæ„å»ºå¤±è´¥"
            fi
            
            # æ¸…ç†Pacmanç¼“å­˜
            sudo chroot "$ROOTFS_MOUNT" pacman -Scc --noconfirm || error_exit "Pacmanç¼“å­˜æ¸…ç†å¤±è´¥"
          fi

          # -------------------------- RHELç³»æ„å»ºï¼ˆä¿®å¤DNFæ¶æ„æŒ‡å®šé—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "rhel-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º RHELç³»ï¼š$DISTRO_NAME $DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # é…ç½®DNFæºï¼ˆåŒºåˆ†Fedoraå’Œå…¶ä»–RHELç³»ï¼‰
            if [ "$DISTRO_NAME" = "fedora" ]; then
              sudo tee "$ROOTFS_MOUNT/etc/yum.repos.d/fedora.repo" << EOF_REPO
              [fedora]
              name=Fedora $DISTRO_RELEASE - aarch64
              baseurl=$DISTRO_MIRROR
              gpgcheck=1
              gpgkey=$DISTRO_GPG
              EOF_REPO
            else
              sudo tee "$ROOTFS_MOUNT/etc/yum.repos.d/${DISTRO_NAME}.repo" << EOF_REPO
              [baseos]
              name=${DISTRO_NAME^} $DISTRO_RELEASE - BaseOS (aarch64)
              baseurl=$DISTRO_MIRROR
              gpgcheck=1
              gpgkey=$DISTRO_GPG
              EOF_REPO
            fi
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿï¼ˆå¼ºåˆ¶æŒ‡å®šaarch64æ¶æ„ï¼‰
            sudo dnf --installroot="$ROOTFS_MOUNT" --releasever="$DISTRO_RELEASE" \
              --forcearch=aarch64 --nogpgcheck install -y basesystem \
              || error_exit "DNFæ„å»ºå¤±è´¥ï¼ˆ--nogpgcheckä¸´æ—¶è§„é¿å¯†é’¥ä¿¡ä»»é—®é¢˜ï¼‰"
            
            # æ¸…ç†DNFç¼“å­˜
            sudo dnf --installroot="$ROOTFS_MOUNT" clean all || error_exit "DNFç¼“å­˜æ¸…ç†å¤±è´¥"
          fi

          # -------------------------- SUSEç³»æ„å»ºï¼ˆä¿®å¤RPMæ•°æ®åº“åˆå§‹åŒ–é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "suse-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º SUSEç³»ï¼š$DISTRO_NAME $DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # åˆå§‹åŒ–RPMæ•°æ®åº“ï¼ˆzypperå¿…éœ€æ­¥éª¤ï¼‰
            sudo rpm --root "$ROOTFS_MOUNT" --initdb || error_exit "RPMæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
            
            # æ·»åŠ ZYPPERæºå¹¶åˆ·æ–°
            sudo zypper addrepo -f -n "OpenSUSE $DISTRO_RELEASE" "$DISTRO_MIRROR" opensuse-repo \
              || error_exit "ZYPPERæºæ·»åŠ å¤±è´¥"
            sudo zypper --installroot="$ROOTFS_MOUNT" refresh || error_exit "ZYPPERæºåˆ·æ–°å¤±è´¥"
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿï¼ˆ--no-recommendså‡å°‘å†—ä½™åŒ…ï¼‰
            sudo zypper --installroot="$ROOTFS_MOUNT" --arch=aarch64 \
              install -y --no-recommends patterns-base-base \
              || error_exit "ZYPPERæ„å»ºå¤±è´¥"
            
            # æ¸…ç†ZYPPERç¼“å­˜
            sudo zypper --installroot="$ROOTFS_MOUNT" clean -a || error_exit "ZYPPERç¼“å­˜æ¸…ç†å¤±è´¥"
          fi

          # -------------------------- Alpineç³»æ„å»ºï¼ˆä¿®å¤é•œåƒè·¯å¾„+å¯†é’¥é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "alpine-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Alpineç³»ï¼š$DISTRO_NAME $DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # ä¸‹è½½Alpineå®˜æ–¹æ„å»ºå·¥å…·
            wget -O /tmp/alpine-make-rootfs \
              https://raw.githubusercontent.com/alpinelinux/alpine-make-rootfs/master/alpine-make-rootfs \
              || error_exit "Alpineæ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥"
            chmod +x /tmp/alpine-make-rootfs
            
            # æ„å»ºRootFSï¼ˆAdelieéœ€é¢å¤–æŒ‡å®šå¯†é’¥ï¼‰
            if [ "$DISTRO_NAME" = "adelie" ]; then
              sudo /tmp/alpine-make-rootfs -a aarch64 -s "$DISTRO_MIRROR" \
                -k "$DISTRO_GPG" "$ROOTFS_NAME" "$DISTRO_RELEASE" \
                || error_exit "Adelieæ„å»ºå¤±è´¥"
            else
              sudo /tmp/alpine-make-rootfs -a aarch64 -s "$DISTRO_MIRROR" \
                "$ROOTFS_NAME" "$DISTRO_RELEASE" \
                || error_exit "Alpineæ„å»ºå¤±è´¥"
            fi
            
            echo "âœ… $DISTRO_NAME æ„å»ºå®Œæˆï¼ˆè‡ªåŠ¨å‹ç¼©ä¸ºxzæ ¼å¼ï¼‰"
            exit 0  # è·³è¿‡åç»­ç»Ÿä¸€å‹ç¼©æ­¥éª¤
          fi

          # -------------------------- Voidæ„å»ºï¼ˆä¿®å¤æ¶æ„æŒ‡å®š+ä¾èµ–é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "void-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Voidï¼š$DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿï¼ˆå¼ºåˆ¶æŒ‡å®šaarch64æ¶æ„ï¼Œé¿å…x86_64åŒ…ï¼‰
            sudo xbps-install -S -r "$ROOTFS_MOUNT" -R "$DISTRO_MIRROR" \
              --arch=aarch64 base-system \
              || error_exit "xbps-installæ„å»ºå¤±è´¥"
            
            # æ¸…ç†XBPSç¼“å­˜
            sudo xbps-remove -r "$ROOTFS_MOUNT" -O || error_exit "Voidç¼“å­˜æ¸…ç†å¤±è´¥"
          fi

          # -------------------------- Pardusæ„å»ºï¼ˆå¤ç”¨Debiané€»è¾‘ï¼Œè¡¥å……æºé…ç½®ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "pardus-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Pardusï¼š$DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # é…ç½®APTæº
            sudo tee "$ROOTFS_MOUNT/etc/apt/sources.list" << EOF_REPO
            deb $DISTRO_MIRROR /
            EOF_REPO
            
            # æ‰§è¡Œdebootstrapï¼ˆåŒDebianç³»ï¼‰
            sudo debootstrap --arch=arm64 --foreign "$DISTRO_RELEASE" "$ROOTFS_MOUNT" "$DISTRO_MIRROR" \
              || error_exit "Pardus debootstrapç¬¬ä¸€é˜¶æ®µå¤±è´¥"
            sudo cp /usr/bin/qemu-aarch64-static "$ROOTFS_MOUNT/usr/bin/" \
              || error_exit "QEMUå¤åˆ¶å¤±è´¥"
            sudo chroot "$ROOTFS_MOUNT" /debootstrap/debootstrap --second-stage \
              || error_exit "Pardus debootstrapç¬¬äºŒé˜¶æ®µå¤±è´¥"
            
            # æ¸…ç†APTç¼“å­˜
            sudo chroot "$ROOTFS_MOUNT" apt clean || error_exit "Pardus APTæ¸…ç†å¤±è´¥"
          fi

          # -------------------------- Chimeraæ„å»ºï¼ˆä¿®å¤APKæ•°æ®åº“åˆå§‹åŒ–é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "chimera-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Chimeraï¼š$DISTRO_RELEASE (arm64)"
            import_gpg "$DISTRO_GPG"
            
            # åˆå§‹åŒ–APKæ•°æ®åº“ï¼ˆChimeraåŸºäºapkï¼Œå¿…éœ€æ­¥éª¤ï¼‰
            sudo apk --root "$ROOTFS_MOUNT" add --initdb || error_exit "APKæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
            
            # é…ç½®APKæº
            sudo mkdir -p "$ROOTFS_MOUNT/etc/apk"
            sudo tee "$ROOTFS_MOUNT/etc/apk/repositories" << EOF_REPO
            $DISTRO_MIRROR
            EOF_REPO
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿ
            sudo apk --root "$ROOTFS_MOUNT" --arch aarch64 add base \
              || error_exit "Chimera APKå®‰è£…å¤±è´¥"
            
            # æ¸…ç†APKç¼“å­˜
            sudo apk --root "$ROOTFS_MOUNT" cache clean || error_exit "Chimera APKæ¸…ç†å¤±è´¥"
          fi

          # -------------------------- Gentooæ„å»ºï¼ˆä¿®å¤Stage3ä¸‹è½½æ­£åˆ™+æƒé™é—®é¢˜ï¼‰ --------------------------
          if [ "$DISTRO_TYPE" = "gentoo-like" ]; then
            echo "ğŸš€ å¼€å§‹æ„å»º Gentooï¼š$DISTRO_RELEASE (arm64)"
            # ä¸‹è½½æœ€æ–°Stage3é•œåƒï¼ˆæ­£åˆ™åŒ¹é…å‡†ç¡®çš„æ–‡ä»¶åï¼‰
            STAGE3_URL=$(curl -fsSL "$DISTRO_MIRROR" | \
              grep -oE 'href="stage3-arm64-desktop-systemd-[0-9]{8}-[0-9]+\.tar\.xz"' | \
              head -n1 | sed 's/href="//;s/"//')
            [ -z "$STAGE3_URL" ] && error_exit "æœªæ‰¾åˆ°Gentoo Stage3 aarch64é•œåƒï¼ˆæ£€æŸ¥é•œåƒåœ°å€ï¼‰"
            
            # ä¸‹è½½å¹¶è§£å‹Stage3
            sudo wget -O /tmp/gentoo-stage3.tar.xz "$DISTRO_MIRROR/$STAGE3_URL" \
              || error_exit "Gentoo Stage3ä¸‹è½½å¤±è´¥"
            sudo tar -xJf /tmp/gentoo-stage3.tar.xz -C "$ROOTFS_MOUNT" \
              || error_exit "Gentoo Stage3è§£å‹å¤±è´¥"
            
            # é…ç½®Gentooç¼–è¯‘å‚æ•°
            sudo tee "$ROOTFS_MOUNT/etc/portage/make.conf" << EOF
            CHOST="aarch64-unknown-linux-gnu"
            ARCH="arm64"
            MAKEOPTS="-j\$(nproc)"  # è‡ªåŠ¨é€‚é…CPUæ ¸å¿ƒæ•°
            EOF
          fi

          # -------------------------- ç»Ÿä¸€å‹ç¼©RootFSï¼ˆé™¤Alpineç³»å¤–ï¼‰ --------------------------
          echo "ğŸ“¦ å‹ç¼©RootFSäº§ç‰©ï¼ˆxzæ ¼å¼ï¼Œé«˜å‹ç¼©ç‡ï¼‰..."
          sudo tar -cJf "$ROOTFS_NAME" -C "$ROOTFS_MOUNT" . \
            || error_exit "RootFSå‹ç¼©å¤±è´¥ï¼ˆæ£€æŸ¥ç£ç›˜ç©ºé—´ï¼‰"
          # ä¿®æ­£äº§ç‰©æƒé™ï¼ˆç¡®ä¿GitHub Actionså¯è¯»å–ï¼‰
          sudo chown "$USER:$USER" "$ROOTFS_NAME" || error_exit "äº§ç‰©æƒé™ä¿®æ­£å¤±è´¥"

          # -------------------------- æ¸…ç†ç¯å¢ƒï¼ˆè°ƒè¯•æ¨¡å¼é™¤å¤–ï¼‰ --------------------------
          if [ "$DEBUG_MODE" = "false" ]; then
            sudo umount -l "$ROOTFS_MOUNT" 2>/dev/null || true
            sudo rm -rf "$ROOTFS_MOUNT" /tmp/*.gpg /tmp/gentoo-stage3.tar.xz /tmp/alpine-make-rootfs
          fi

          echo -e "\033[32mâœ… $DISTRO_NAME $DISTRO_RELEASE (arm64) æ„å»ºå®Œæˆï¼äº§ç‰©ï¼š$ROOTFS_NAME\033[0m"
          EOF
          # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x build.sh || { echo "âŒ æ„å»ºè„šæœ¬æƒé™è®¾ç½®å¤±è´¥"; exit 1; }
          echo "âœ… æ„å»ºè„šæœ¬ç”Ÿæˆå®Œæˆ"

      # 5. æ‰§è¡Œæ„å»ºï¼ˆæ•è·é”™è¯¯å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰
      - name: Build arm64 RootFS
        run: |
          set -euo pipefail
          # æ‰“å°æ„å»ºè„šæœ¬å†…å®¹ï¼ˆä¾¿äºæ’é”™ï¼‰
          echo "ğŸ“„ æ„å»ºè„šæœ¬å†…å®¹ï¼š"
          cat build.sh
          echo -e "\nğŸš€ å¼€å§‹æ‰§è¡Œæ„å»º..."
          # æ‰§è¡Œæ„å»ºï¼ˆå¤±è´¥æ—¶è¾“å‡ºæ˜ç¡®æç¤ºï¼‰
          ./build.sh "${{ env.ROOTFS_NAME }}" "${{ env.ROOTFS_MOUNT }}" || {
            echo -e "\033[31mâŒ ${{ matrix.name }} æ„å»ºå¤±è´¥ï¼æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—æ’æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š\033[0m"
            echo "  1. é•œåƒæºæ˜¯å¦æ”¯æŒarm64æ¶æ„"
            echo "  2. GPGå¯†é’¥æ˜¯å¦æœ‰æ•ˆï¼ˆå¯å°è¯•--nogpgcheckä¸´æ—¶è§„é¿ï¼‰"
            echo "  3. ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ï¼ˆubuntu-latesté»˜è®¤14GBï¼‰"
            exit 1
          }

      # 6. éªŒè¯äº§ç‰©æœ‰æ•ˆæ€§ï¼ˆæ’é™¤ç©ºæ–‡ä»¶/æŸåæ–‡ä»¶ï¼‰
      - name: Validate RootFS
        run: |
          set -euo pipefail
          ROOTFS_PATH="./${{ env.ROOTFS_NAME }}"
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          [ -f "$ROOTFS_PATH" ] || { echo -e "\033[31mâŒ äº§ç‰©æ–‡ä»¶ä¸å­˜åœ¨\033[0m"; exit 1; }
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå°äº10MBè§†ä¸ºæ— æ•ˆï¼Œæ’é™¤ç©ºäº§ç‰©ï¼‰
          MIN_SIZE=$((10 * 1024 * 1024))  # 10MB
          FILE_SIZE=$(stat -c%s "$ROOTFS_PATH")
          if [ "$FILE_SIZE" -lt "$MIN_SIZE" ]; then
            echo -e "\033[31mâŒ äº§ç‰©æ— æ•ˆï¼ˆå¤§å°ï¼š$(du -sh "$ROOTFS_PATH" | awk '{print $1}') < 10MBï¼‰\033[0m"
            exit 1
          fi
          # æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§ï¼ˆå°è¯•è§£å‹æµ‹è¯•ï¼‰
          echo "ğŸ” æµ‹è¯•äº§ç‰©å®Œæ•´æ€§ï¼ˆè§£å‹å‰100KBéªŒè¯ï¼‰..."
          head -c 102400 "$ROOTFS_PATH" | xz -t >/dev/null 2>&1 || {
            echo -e "\033[31mâŒ äº§ç‰©æŸåï¼ˆxzè§£å‹éªŒè¯å¤±è´¥ï¼‰\033[0m"
            exit 1
          }
          echo -e "\033[32mâœ… äº§ç‰©éªŒè¯é€šè¿‡ï¼\033[0m"
          echo "  - è·¯å¾„ï¼š$ROOTFS_PATH"
          echo "  - å¤§å°ï¼š$(du -sh "$ROOTFS_PATH" | awk '{print $1}')"
          echo "  - å®Œæ•´æ€§ï¼šxzè§£å‹æµ‹è¯•é€šè¿‡"

      # 7. ä¸Šä¼ äº§ç‰©åˆ°GitHub Releaseï¼ˆç¡®ä¿æ ‡ç­¾å”¯ä¸€ï¼Œé¿å…å†²çªï¼‰
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # è‡ªåŠ¨æ³¨å…¥ä»“åº“ä»¤ç‰Œï¼Œæ— éœ€é¢å¤–é…ç½®
        with:
          # æ ‡ç­¾æ ¼å¼ï¼šarm64-rootfs-å‘è¡Œç‰ˆ-ç‰ˆæœ¬-æ—¥æœŸï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
          tag_name: arm64-rootfs-${{ matrix.name }}-${{ matrix.release }}-${{ format('{0:YYYYMMdd}', github.run_started_at) }}
          # å‘å¸ƒåç§°ï¼šåŒ…å«å‘è¡Œç‰ˆã€ç‰ˆæœ¬ã€æ—¥æœŸï¼ˆæ˜“è¯»ï¼‰
          release_name: "arm64 RootFS | ${{ matrix.name }} ${{ matrix.release }} (${{ format('{0:YYYY-MM-dd}', github.run_started_at) }})"
          draft: false  # ç›´æ¥å‘å¸ƒï¼Œä¸å­˜è‰ç¨¿
          prerelease: false  # æ ‡è®°ä¸ºæ­£å¼ç‰ˆæœ¬

      - name: Upload RootFS to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}  # ä»åˆ›å»ºReleaseæ­¥éª¤è·å–ä¸Šä¼ åœ°å€
          asset_path: ./${{ env.ROOTFS_NAME }}  # äº§ç‰©è·¯å¾„
          asset_name: ${{ env.ROOTFS_NAME }}  # ä¸Šä¼ åçš„æ–‡ä»¶åï¼ˆä¸æœ¬åœ°ä¸€è‡´ï¼‰
          asset_content_type: application/x-xz  # æ­£ç¡®çš„MIMEç±»å‹ï¼ˆxzå‹ç¼©æ–‡ä»¶ï¼‰
