name: Build ARM64 RootFS
on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/rootfs.yml'
      - 'Dockerfile.*'
  workflow_dispatch:
permissions:
  contents: write  # 核心权限，允许创建/修改 Release
  actions: read    # 可选，仅用于读取 workflow 状态（避免其他潜在权限问题）
jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      - uses: docker/setup-buildx-action@v3
      - run: |
          mkdir -p ./rootfs-output
          docker build --platform linux/arm64 -t ubuntu-rootfs -f Dockerfile.ubuntu .
          CID=$(docker run -d --platform linux/arm64 ubuntu-rootfs sleep 30)
          docker export $CID | xz -9e > ./rootfs-output/ubuntu-22.04-arm64-rootfs.tar.xz
          docker stop $CID && docker rm $CID
      - uses: actions/upload-artifact@v4
        with:
          name: ubuntu-rootfs
          path: ./rootfs-output/ubuntu-22.04-arm64-rootfs.tar.xz
          retention-days: 1

  create-release:
    runs-on: ubuntu-latest
    needs: build-ubuntu
    steps:
      - run: mkdir -p ./rootfs-output
      - uses: actions/download-artifact@v4
        with:
          path: ./rootfs-output
          pattern: ubuntu-rootfs
          merge-multiple: true
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.sha_short }}
          files: ./rootfs-output/*.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
